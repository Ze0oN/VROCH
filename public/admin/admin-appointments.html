<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Admin - All Appointments</title>
  <style>
    body { font-family: Arial, sans-serif; background-color: #f5f6fa; padding: 30px; }
    h2 { text-align: center; }
    input, select, button { padding: 6px; margin: 5px; border-radius: 5px; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { padding: 10px; border-bottom: 1px solid #ddd; text-align: center; }
    th { background-color: #007bff; color: white; }
    .danger { background-color: #ff4d4d; color: white; }
    .primary { background-color: #4A90E2; color: white; }
    .filters { text-align: center; margin-bottom: 20px; }
  </style>
</head>
<body>
  <h2>Manage All Appointments</h2>

  <div class="filters">
    <input id="filterDoctor" placeholder="Doctor Name">
    <input id="filterPatient" placeholder="Patient Name">
    <input id="filterDate" type="date">
    <select id="filterStatus">
      <option value="">--Status--</option>
      <option value="pending">Pending</option>
      <option value="confirmed">Confirmed</option>
      <option value="completed">Completed</option>
      <option value="cancelled">Cancelled</option>
    </select>
    <button onclick="loadAppointments()">Filter</button>
    <button onclick="resetFilters()">Reset</button>
  </div>

  <table>
    <thead>
      <tr>
        <th>Date</th>
        <th>Time</th>
        <th>Doctor</th>
        <th>Patient</th>
        <th>Status</th>
        <th>Delete</th>
        <th>Reassign Doctor</th>
      </tr>
    </thead>
    <tbody id="appointmentsTable"></tbody>
  </table>

  <button onclick="window.location.href='../admin-dashboard.html'" class="primary" style="margin-top: 30px;">â¬… Back to Dashboard</button>

  <script>
    window.addEventListener('DOMContentLoaded', () => {
      const token = localStorage.getItem('token');
      const role = localStorage.getItem('userRole');

      if (!token || role !== 'admin') {
        localStorage.clear();
        window.location.href = '../login.html';
      }
    });
    function authHeaders() {
      return {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer ' + localStorage.getItem('token')
      };
    }

    function resetFilters() {
      document.getElementById('filterDoctor').value = '';
      document.getElementById('filterPatient').value = '';
      document.getElementById('filterDate').value = '';
      document.getElementById('filterStatus').value = '';
      loadAppointments();
    }

    async function loadAppointments() {
      const d = document.getElementById('filterDoctor').value;
      const p = document.getElementById('filterPatient').value;
      const date = document.getElementById('filterDate').value;
      const status = document.getElementById('filterStatus').value;

      let url = '/api/admin/appointments?';
      if (d) url += `doctor=${encodeURIComponent(d)}&`;
      if (p) url += `patient=${encodeURIComponent(p)}&`;
      if (date) url += `date=${date}&`;
      if (status) url += `status=${status}&`;

      const res = await fetch(url, { headers: authHeaders() });
      const data = await res.json();

      const tbody = document.getElementById('appointmentsTable');
      tbody.innerHTML = '';

      data.forEach(app => {
        const row = document.createElement('tr');

        row.innerHTML = `
          <td>${app.appointment_date}</td>
          <td>${app.appointment_start_time} - ${app.appointment_end_time}</td>
          <td>${app.doctor_name}</td>
          <td>${app.patient_name}</td>
          <td>${app.status}</td>
          <td><button class="danger" onclick="deleteAppointment(${app.id})">Delete</button></td>
          <td>
            <input type="number" id="reassign-${app.id}" placeholder="Doctor ID">
            <button onclick="reassign(${app.id})">Reassign</button>
          </td>
        `;
        tbody.appendChild(row);
      });
    }

    async function deleteAppointment(id) {
        if (!confirm('Delete this appointment?')) return;

        try {
            const res = await fetch(`/api/admin/appointments/${id}`, {
            method: 'DELETE',
            headers: authHeaders()
            });

            const result = await res.json();

            if (!res.ok) {
            alert(result.error || 'Failed to delete appointment.');
            } else {
            alert(result.message || 'Appointment deleted.');
            loadAppointments();
            }
        } catch (err) {
            alert('Unexpected error. Please try again.');
            console.error(err);
        }
    }

    async function reassign(id) {
      const newId = document.getElementById(`reassign-${id}`).value;
      if (!newId) return alert('Enter a doctor ID.');

      const res = await fetch(`/api/admin/appointments/${id}/reassign`, {
        method: 'PUT',
        headers: authHeaders(),
        body: JSON.stringify({ doctor_id: newId })
      });
      const result = await res.json();
      alert(result.message);
      loadAppointments();
    }

    window.onload = loadAppointments;
  </script>
</body>
</html>
