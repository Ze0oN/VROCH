<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Charts & Analytics</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: sans-serif; }
    canvas { background: #fff; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
  </style>
</head>
<body class="bg-gray-100 p-8">
  <div class="max-w-6xl mx-auto space-y-10">
    <h1 class="text-3xl font-bold mb-4">ðŸ“Š Charts & Analytics</h1>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <div>
        <h2 class="text-xl font-semibold mb-2">Top Doctors by Appointments</h2>
        <canvas id="topDoctorsChart" height="300"></canvas>
      </div>

      <div>
        <h2 class="text-xl font-semibold mb-2">Top Ordered Medications</h2>
        <canvas id="topMedicationsChart" height="300"></canvas>
      </div>

      <div class="md:col-span-2">
        <h2 class="text-xl font-semibold mb-2">Subscription Distribution</h2>
        <canvas id="subscriptionsChart" height="300"></canvas>
      </div>
    </div>

    <button onclick="back()" class="mt-8 text-blue-600 underline">Back to Dashboard</button>
  </div>

  <script>
    async function fetchChart(endpoint) {
      const res = await fetch(`/api/admin/charts/${endpoint}`, {
        headers: {
          Authorization: 'Bearer ' + localStorage.getItem('token')
        }
      });
      if (!res.ok) throw new Error(`Failed to load ${endpoint}`);
      return await res.json();
    }

    function back() {
      window.location.href = '../admin-dashboard.html';
    }

    async function loadCharts() {
      try {
        const [doctors, meds, subs] = await Promise.all([
          fetchChart('top-doctors'),
          fetchChart('top-medications'),
          fetchChart('subscription-distribution')
        ]);

        renderBarChart('topDoctorsChart', doctors, 'Appointments');
        renderBarChart('topMedicationsChart', meds, 'Orders');
        renderPieChart('subscriptionsChart', subs);

      } catch (err) {
        alert('Error loading charts: ' + err.message);
      }
    }

    function renderBarChart(id, data, label) {
      new Chart(document.getElementById(id), {
        type: 'bar',
        data: {
          labels: data.labels,
          datasets: [{
            label,
            data: data.values,
            backgroundColor: ['#3b82f6', '#22c55e', '#f59e0b', '#ef4444', '#8b5cf6']
          }]
        },
        options: {
          responsive: true,
          scales: {
            y: { beginAtZero: true }
          }
        }
      });
    }

    function renderPieChart(id, data) {
      new Chart(document.getElementById(id), {
        type: 'pie',
        data: {
          labels: data.labels,
          datasets: [{
            data: data.values,
            backgroundColor: ['#0ea5e9', '#f97316', '#10b981', '#eab308', '#6366f1']
          }]
        },
        options: { responsive: true }
      });
    }

    window.addEventListener('DOMContentLoaded', loadCharts);
  </script>
</body>
</html>
