<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>All Pharmacy Orders</title>
  <style>
    body { font-family: Arial; background: #f4f6f8; padding: 20px; }
    table { width: 100%; border-collapse: collapse; background: white; margin-top: 20px; }
    th, td { padding: 12px; border: 1px solid #ccc; text-align: left; }
    th { background-color: #2c7a7b; color: white; }
    select, button {
      padding: 5px 10px;
      margin-right: 5px;
      border-radius: 4px;
    }
    a.button {
      padding: 5px 10px;
      background: #2c7a7b;
      color: white;
      border-radius: 4px;
      text-decoration: none;
    }
    .back-btn {
      margin-bottom: 15px;
      padding: 8px 16px;
      background: #6c757d;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <button class="back-btn" onclick="goBack()">‚Üê Back to Dashboard</button>
  <h2>All Pharmacy Orders</h2>
  <table id="ordersTable">
    <thead>
      <tr>
        <th>Order ID</th>
        <th>Patient ID</th>
        <th>Medications</th>
        <th>Total (SAR)</th>
        <th>Status</th>
        <th>Prescription</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

<script>
  function goBack() {
    const role = localStorage.getItem('userRole');
    if (role === 'admin') {
      window.location.href = '/admin-dashboard.html';
    } else if (role === 'doctor') {
      window.location.href = '/doctor-dashboard.html';
    } else if (role === 'patient') {
      window.location.href = '/patient-dashboard.html';
    } else {
      window.location.href = '/login.html';
    }
  }

  async function fetchOrders() {
    const res = await fetch('/api/pharmacy-orders', {
      headers: { 'Authorization': 'Bearer ' + localStorage.getItem('token') }
    });

    const data = await res.json();
    const tbody = document.querySelector('#ordersTable tbody');
    tbody.innerHTML = '';

    data.forEach(order => {
      const meds = JSON.parse(order.medications).join(', ');
      const filename = order.prescription_file ? order.prescription_file.split('/').pop() : null;
      const row = document.createElement('tr');

      row.innerHTML = `
        <td>${order.id}</td>
        <td>${order.patient_id}</td>
        <td>${meds}</td>
        <td>${parseFloat(order.total_amount).toFixed(2)}</td>
        <td><strong>${order.status}</strong></td>
        <td>${filename ? `<a class="button" href="/${order.prescription_file}" target="_blank">View</a>` : 'N/A'}</td>
        <td>
          <select id="status-${order.id}">
            <option value="pending">pending</option>
            <option value="approved">approved</option>
            <option value="dispatched">dispatched</option>
            <option value="delivered">delivered</option>
            <option value="cancelled">cancelled</option>
          </select>
          <button onclick="updateStatus(${order.id})">Update</button>
        </td>
      `;

      tbody.appendChild(row);
      document.getElementById(`status-${order.id}`).value = order.status;
    });
  }

  async function updateStatus(orderId) {
    const newStatus = document.getElementById(`status-${orderId}`).value;
    const res = await fetch(`/api/pharmacy-orders/${orderId}`, {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer ' + localStorage.getItem('token')
      },
      body: JSON.stringify({ new_status: newStatus })
    });

    const data = await res.json();
    alert(res.ok ? 'Status updated!' : 'Error: ' + data.error);
    if (res.ok) fetchOrders();
  }

  fetchOrders();
</script>

</body>
</html>
