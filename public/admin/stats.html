<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin Statistics</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen p-6">
  <div class="max-w-6xl mx-auto bg-white p-6 rounded-lg shadow-lg">
    <h1 class="text-3xl font-bold mb-6">Admin Statistics Dashboard</h1>

    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="statsContainer">
      <!-- Stats cards will be injected here -->
    </div>
    <button onclick="back()" style="background-color: white; color: #444;">Back</button>
  </div>

  <script>
    window.addEventListener('DOMContentLoaded', () => {
        const token = localStorage.getItem('token');
        const role = localStorage.getItem('userRole');

        if (!token || role !== 'admin') {
        localStorage.clear();
        window.location.href = '../login.html';
        }
    });

    function back() {
      window.location.href = '../admin-dashboard.html';
    }

    async function fetchStats(endpoint) {
      const res = await fetch(`/api/admin/stats/${endpoint}`, {
        headers: {
          'x-user-role': localStorage.getItem('userRole'),
          'x-user-id': localStorage.getItem('userId')
        }
      });
      return res.json();
    }

    function createCard(title, contentHtml) {
      return `
        <div class="bg-white border border-gray-200 rounded-lg shadow-sm p-4">
          <h2 class="text-xl font-semibold mb-2">${title}</h2>
          <div class="text-sm space-y-1">${contentHtml}</div>
        </div>
      `;
    }

    async function loadStats() {
      const container = document.getElementById('statsContainer');
      container.innerHTML = '';

      const [
        usersByRole,
        appointments,
        prescriptions,
        pharmacyOrders,
        revenue,
        subscriptions
      ] = await Promise.all([
        fetchStats('users-by-role'),
        fetchStats('appointments'),
        fetchStats('prescriptions'),
        fetchStats('pharmacy-orders'),
        fetchStats('revenue'),
        fetchStats('subscriptions')
      ]);

      // Users by role
      const usersHtml = usersByRole.map(r => `${r.role}: <strong>${r.count}</strong>`).join('<br>');
      container.innerHTML += createCard('üë• Users by Role', usersHtml);

      // Appointments by status
      const appHtml = appointments.map(a => `${a.status}: <strong>${a.count}</strong>`).join('<br>');
      container.innerHTML += createCard('üìÖ Appointments', appHtml);

      // Prescriptions by doctor
      const presHtml = prescriptions.map(p => `${p.doctor_name}: <strong>${p.count}</strong>`).join('<br>');
      container.innerHTML += createCard('üíä Prescriptions', presHtml);

      // Pharmacy orders
      const pharmHtml = pharmacyOrders.map(p => `${p.status}: <strong>${p.count}</strong>`).join('<br>');
      container.innerHTML += createCard('üè• Pharmacy Orders', pharmHtml);

      // Revenue
      const revHtml = `
        <div class="mb-1 font-semibold">Monthly:</div>
        ${revenue.monthly.map(r => `${new Date(r.month).toLocaleDateString('en-MY', { year: 'numeric', month: 'short' })}: SAR ${r.total}`).join('<br>')}
        <div class="mt-2 font-semibold">Yearly:</div>
        ${revenue.yearly.map(r => `${new Date(r.year).getFullYear()}: SAR ${r.total}`).join('<br>')}
      `;
      container.innerHTML += createCard('üí∞ Revenue (Paid Bills)', revHtml);

      // Subscriptions
      const subsHtml = subscriptions.map(s => `${s.plan_name}: <strong>${s.count}</strong>`).join('<br>');
      container.innerHTML += createCard('üì¶ Active Subscriptions', subsHtml);
    }

    loadStats();
  </script>
</body>
</html>
